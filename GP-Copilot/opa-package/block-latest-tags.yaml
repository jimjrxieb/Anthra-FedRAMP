# Kyverno ClusterPolicy
# Purpose: PREVENT findings like 4629194 (Image tag :latest)
# Enforcement: Admission control (blocks kubectl apply)
# Related JSA Findings: Image tag ":latest" used

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: block-latest-tags
  annotations:
    policies.kyverno.io/title: Block Latest Image Tags
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Image tags should be pinned to a specific version (not :latest).
      This ensures reproducible deployments and prevents unexpected updates.
      Required by FedRAMP CM-2 (Baseline Configuration).
spec:
  validationFailureAction: Enforce  # Change to Audit for testing
  background: true
  rules:
    - name: require-specific-tags
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
                - Pod
      validate:
        message: >-
          Image tags must be specific versions, not :latest.
          Use semantic versioning (e.g., anthra/api:1.2.3).
        pattern:
          spec:
            =(ephemeralContainers):
              - =(image): "!*:latest"
            =(initContainers):
              - =(image): "!*:latest"
            containers:
              - image: "!*:latest"

---
# Additional rules for stricter enforcement:
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-semver-tags
  annotations:
    policies.kyverno.io/title: Require Semantic Versioning Tags
    policies.kyverno.io/description: >-
      Image tags must follow semantic versioning (vX.Y.Z or X.Y.Z).
      Examples: v1.0.0, 2.1.3, 1.0.0-rc1
spec:
  validationFailureAction: Audit  # Less strict, just warns
  background: true
  rules:
    - name: semver-tags-only
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
      validate:
        message: >-
          Image tags should follow semantic versioning (e.g., v1.2.3).
          Untagged images or non-semver tags may indicate dev/test images.
        foreach:
          - list: "request.object.spec.template.spec.containers"
            pattern:
              image: "*:v?[0-9].[0-9].[0-9]*"

---
# Test this policy:
# kubectl apply -f block-latest-tags.yaml
#
# Then try to deploy with :latest:
# kubectl apply -f - <<EOF
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: test
# spec:
#   template:
#     spec:
#       containers:
#         - name: test
#           image: nginx:latest  # Should FAIL
# EOF
#
# Expected Error:
# Error from server: admission webhook "validate.kyverno.svc-fail" denied:
# policy Deployment/default/test for resource violation:
# block-latest-tags:
#   require-specific-tags: validation error: Image tags must be specific versions

---
# NIST 800-53 Control Mapping:
# - CM-2: Baseline Configuration (specific versions)
# - CM-2(2): Automation Support for Accuracy/Currency
# - SA-10: Developer Configuration Management
#
# FedRAMP Moderate Requirement:
# All deployed artifacts must be versioned and traceable.
