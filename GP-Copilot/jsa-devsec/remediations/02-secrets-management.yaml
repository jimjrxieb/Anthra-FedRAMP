# JSA-DevSec Auto-Generated Remediation
# Category: Secrets Management
# Findings: 1762294, 5170944, 3470005, 2135050, 8465107, 5346728
# Rank: D (Auto-fix with logging)
# Date: 2026-02-12

---
# BEFORE (Current State - VULNERABLE):
# Hard-coded credentials in:
# - docker-compose.yml (lines 11, 13, 21, 23)
# - infrastructure/api-deployment.yaml (line 38)
# - services/main.go (line 16)

# Example of VULNERABLE code:
# env:
#   - name: DB_PASSWORD
#     value: anthra_default_pass_123  # CWE-798: Hard-coded credential

# AFTER (FedRAMP Compliant):

---
# Step 1: Create Kubernetes Secret
apiVersion: v1
kind: Secret
metadata:
  name: anthra-db-credentials
  namespace: anthra
type: Opaque
stringData:
  db-password: REPLACE_WITH_SECURE_GENERATED_PASSWORD
  db-user: anthra
  db-host: anthra-db
  db-port: "5432"
  db-name: anthra

---
# Step 2: Update Deployment to use secretKeyRef
apiVersion: apps/v1
kind: Deployment
metadata:
  name: anthra-api
  namespace: anthra
spec:
  template:
    spec:
      containers:
        - name: api
          image: anthra/api:1.0.0
          env:
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: anthra-db-credentials
                  key: db-host

            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: anthra-db-credentials
                  key: db-port

            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: anthra-db-credentials
                  key: db-name

            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: anthra-db-credentials
                  key: db-user

            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: anthra-db-credentials
                  key: db-password

---
# Step 3: For AWS EKS - Use ExternalSecrets Operator
# (Recommended for production FedRAMP deployments)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: anthra-db-credentials
  namespace: anthra
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: anthra-db-credentials
    creationPolicy: Owner
  data:
    - secretKey: db-password
      remoteRef:
        key: anthra/production/db-credentials
        property: password
    - secretKey: db-user
      remoteRef:
        key: anthra/production/db-credentials
        property: username
    - secretKey: db-host
      remoteRef:
        key: anthra/production/db-credentials
        property: host

---
# Step 4: SecretStore (connects to AWS Secrets Manager)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: anthra
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: anthra-api  # ServiceAccount with IRSA role

---
# NIST 800-53 Control Mapping:
# - IA-5(7): No Embedded Unencrypted Static Authenticators
# - SC-28: Protection of Information at Rest (encrypted Secrets)
# - AC-3: Access Enforcement (RBAC for Secrets)

---
# JSA-DevSec Remediation Steps:
# 1. Detect hardcoded secrets (Gitleaks findings)
# 2. Generate K8s Secret manifest with placeholder
# 3. Rewrite Deployment to use secretKeyRef
# 4. (Optional) Generate ExternalSecret for AWS Secrets Manager
# 5. Add to POA&M: "Rotate all exposed credentials (git history)"
# 6. Log fix to feedback system

---
# CRITICAL: Git History Contaminated
# All hardcoded credentials have been committed to git.
# Even after this fix, they remain in history.
#
# Required Actions (Manual):
# 1. Rotate ALL credentials immediately
# 2. Add .env to .gitignore (if using local dev)
# 3. Use git-filter-repo to remove secrets from history:
#    git filter-repo --path docker-compose.yml --invert-paths
# 4. Force push to rewrite history (coordinate with team)
#
# This is logged as a HIGH priority POA&M item for GuidePoint.
