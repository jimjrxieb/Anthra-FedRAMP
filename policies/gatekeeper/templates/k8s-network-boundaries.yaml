apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8snetworkboundaries
  annotations:
    description: >-
      Enforces network boundary protection: namespaces must declare
      default-deny NetworkPolicy, NodePort services are blocked.
      Maps to NIST SC-7 (Boundary Protection).
    novasec.cloud/control: SC-7
spec:
  crd:
    spec:
      names:
        kind: K8sNetworkBoundaries
      validation:
        openAPIV3Schema:
          type: object
          properties:
            blockedServiceTypes:
              type: array
              items:
                type: string
              description: Service types to block
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8snetworkboundaries

        import future.keywords.in

        default blocked_types := ["NodePort"]

        violation[{"msg": msg}] {
          input.review.object.kind == "Namespace"
          ns := input.review.object.metadata.name
          not is_system_ns(ns)
          not input.review.object.metadata.annotations["novasec.cloud/network-policy"]
          msg := sprintf("SC-7: Namespace '%s' must have annotation 'novasec.cloud/network-policy: default-deny'", [ns])
        }

        violation[{"msg": msg}] {
          input.review.object.kind == "Namespace"
          ns := input.review.object.metadata.name
          not is_system_ns(ns)
          val := input.review.object.metadata.annotations["novasec.cloud/network-policy"]
          val != "default-deny"
          msg := sprintf("SC-7: Namespace '%s' network-policy must be 'default-deny', got '%s'", [ns, val])
        }

        violation[{"msg": msg}] {
          input.review.object.kind == "Service"
          svc_type := input.review.object.spec.type
          types := object.get(input.parameters, "blockedServiceTypes", blocked_types)
          svc_type in types
          msg := sprintf("SC-7: Service type '%s' is not allowed â€” use ClusterIP + Ingress", [svc_type])
        }

        violation[{"msg": msg}] {
          input.review.object.kind == "Namespace"
          ns := input.review.object.metadata.name
          not is_system_ns(ns)
          not input.review.object.metadata.labels["novasec.cloud/tenant"]
          msg := sprintf("SC-7: Namespace '%s' must have label 'novasec.cloud/tenant' for network isolation", [ns])
        }

        is_system_ns(ns) {
          ns in {"kube-system", "kube-public", "kube-node-lease", "gatekeeper-system", "falco", "monitoring", "istio-system"}
        }
