apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiretls
  annotations:
    description: >-
      Requires TLS on Ingress resources and mTLS annotations on Services.
      Maps to NIST SC-8 (Transmission Confidentiality).
    novasec.cloud/control: SC-8
spec:
  crd:
    spec:
      names:
        kind: K8sRequireTLS
      validation:
        openAPIV3Schema:
          type: object
          properties:
            mtlsAnnotationKey:
              type: string
              description: Annotation key indicating mTLS is configured
              default: "novasec.cloud/mtls"
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiretls

        violation[{"msg": msg}] {
          input.review.object.kind == "Ingress"
          not input.review.object.spec.tls
          msg := "SC-8: Ingress must configure TLS â€” all external traffic must be encrypted"
        }

        violation[{"msg": msg}] {
          input.review.object.kind == "Ingress"
          tls := input.review.object.spec.tls[_]
          not tls.secretName
          msg := "SC-8: Ingress TLS entry must reference a Secret via secretName"
        }

        violation[{"msg": msg}] {
          input.review.object.kind == "Service"
          ns := input.review.object.metadata.namespace
          not is_system_ns(ns)
          annotation_key := object.get(input.parameters, "mtlsAnnotationKey", "novasec.cloud/mtls")
          not input.review.object.metadata.annotations[annotation_key]
          msg := sprintf("SC-8: Service '%s' must have mTLS annotation '%s: strict'", [input.review.object.metadata.name, annotation_key])
        }

        is_system_ns(ns) {
          ns in {"kube-system", "kube-public", "kube-node-lease", "gatekeeper-system"}
        }
